(function(m,h){typeof exports=="object"&&typeof module<"u"?module.exports=h():typeof define=="function"&&define.amd?define(h):(m=typeof globalThis<"u"?globalThis:m||self,m.Watermark=h())})(this,function(){"use strict";var st=Object.defineProperty;var rt=(m,h,M)=>h in m?st(m,h,{enumerable:!0,configurable:!0,writable:!0,value:M}):m[h]=M;var q=(m,h,M)=>rt(m,typeof h!="symbol"?h+"":h,M);function m(o){return o.replace(/([A-Z])/g,"-$1").toLowerCase()}function h(o){return Object.keys(o).map(t=>`${m(t)}: ${o[t]};`).join(" ")}function M(){return window.devicePixelRatio||1}function z(o,t){for(let e in t)Array.isArray(t[e])&&(o[e]=t[e]),t[e]instanceof Object&&e in o&&Object.assign(t[e],z(o[e],t[e]));return Object.assign(o||{},t),o}function B(o){return/[\u4e00-\u9fa5]/.test(o)}const Y=o=>B(o)?4:3;function _(o){return B(o),2}function C(o,t,e=1,n=!1){const a=document.createElement("canvas"),l=a.getContext("2d"),s=o*e,i=t*e;return a.setAttribute("width",`${s}px`),a.setAttribute("height",`${i}px`),n&&(l.fillStyle=`rgba(${Math.ceil(Math.random()*255)}, ${Math.ceil(Math.random()*255)}, ${Math.ceil(Math.random()*255)}, ${Math.random()})`,l.fillRect(0,0,a.width,a.height)),l.save(),[l,a,s,i]}function Z(o,t,e,n,a,l,s,i,p,g=!1){const[c,f,r,A]=C(n,a,e,g);if(o instanceof HTMLImageElement)c.drawImage(o,0,0,r,A);else{const{color:d,fontSize:u,fontStyle:x,fontWeight:k,fontFamily:ot,textAlign:it}=l,K=Number(u)*e;c.font=`${x} normal ${k} ${K}px/${a}px ${ot}`,c.fillStyle=d,c.textAlign=it,c.textBaseline="top";const j=Array.isArray(o)?o:[o];j==null||j.forEach((U,at)=>{c.fillText(U,r/2,at*(K+Y()*e)+_(U))})}const b=Math.PI/180*Number(t),J=Math.sqrt(n*n+a*a),N=Math.max(n,a,J),[I,Q,W]=C(N,N,e,g);I.translate(W/2,W/2),I.rotate(b),r>0&&A>0&&I.drawImage(f,-r/2,-A/2);function V(d,u){const x=d*Math.cos(b)-u*Math.sin(b),k=d*Math.sin(b)+u*Math.cos(b);return[x,k]}let v=0,L=0,$=0,O=0;const T=r/2,E=A/2;[[-T,-E],[T,-E],[T,E],[-T,E]].forEach(([d,u])=>{const[x,k]=V(d,u);v=Math.min(v,x),L=Math.max(L,x),$=Math.min($,k),O=Math.max(O,k)});const tt=v+W/2,et=$+W/2,y=L-v,S=O-$,R=s*e,F=i*e,X=(y+R)*2,D=S+F,[G,nt]=C(X,D,void 0,g);function P(d=0,u=0){G.globalAlpha=p,G.drawImage(Q,tt,et,y,S,d,u,y,S)}return P(),P(y+R,-S/2-F/2),P(y+R,S/2+F/2),[nt.toDataURL(),X/e,D/e]}const w=class w{constructor(t){if(this.options=z({...w.DEFAULT_WATERMARK_OPTIONS},t),!this.options.container)throw new Error("container is required");if(!this.options.container instanceof HTMLElement)throw new Error("container must be a HTMLElement");getComputedStyle(this.options.container).position==="static"&&(this.options.container.style.position="relative"),this.markStyle=this.getMarkStyle(),this.watermarkMap=new Map,this.renderWatermark()}getMarkStyle(){const{zIndex:t,gap:e,offset:n}=this.options,[a,l]=e,s=a/2,i=l/2,p=(n==null?void 0:n[0])||s,g=(n==null?void 0:n[1])||i;let c=p-s,f=g-i;const r={zIndex:t,position:"absolute",left:0,top:0,width:"100%",height:"100%",pointerEvents:"none",backgroundRepeat:"repeat",backgroundPosition:`${c>0?c:0}px ${f>0?f:0}px`};return c>0&&(r.left=`${c}px`,r.width=`calc(100% - ${c}px)`),f>0&&(r.top=`${f}px`,r.height=`calc(100% - ${f}px)`),r}getMarkSize(t){const{image:e,content:n,font:a={},width:l,height:s}=this.options;let i=120,p=64;if(!e&&t.measureText){t.font=`${Number(a.fontSize||16)}px ${a.fontFamily||"Microsoft YaHei"}`;const g=Array.isArray(n)?n:[n],c=g.map(f=>{const r=t.measureText(f);return[r.width,r.fontBoundingBoxAscent+r.fontBoundingBoxDescent+r.ideographicBaseline]});i=Math.ceil(Math.max(...c.map(f=>f[0]))),p=Math.floor(Math.max(...c.map(f=>f[1])))*g.length+(g.length-1)*Y()}return[l||i,s||p]}appendWatermark(t,e,n){if(n){const a=h({...this.markStyle,backgroundImage:`url('${t}')`,backgroundSize:`${Math.floor(e)}px`,visibility:"visible !important"});if(!this.watermarkMap.get(n)){const s=document.createElement("div");this.watermarkMap.set(n,s);const i=globalThis.MutationObserver||globalThis.WebKitMutationObserver;if(i){let p=new i(()=>{(!n.contains(this.watermarkMap.get(n))||s.getAttribute("style")!==a)&&(this.removeWatermark(n),this.watermarkMap.delete(n),p.disconnect(),p=null,this.renderWatermark())});p.observe(n,{attributes:!0,subtree:!0,childList:!0})}}const l=this.watermarkMap.get(n);l.setAttribute("style",a),n.append(l)}}removeWatermark(t){const e=this.watermarkMap.get(t);e&&t&&t.contains(e)&&t.removeChild(e),this.watermarkMap.delete(t)}renderWatermark(){const e=document.createElement("canvas").getContext("2d");if(e){const n=M(),[a,l]=this.getMarkSize(e),s=i=>{const[p,g]=Z(i,this.options.rotate,n,i.width||a,i.height||l,{color:this.options.font.color,fontSize:this.options.font.fontSize,fontStyle:this.options.font.fontStyle,fontWeight:this.options.font.fontWeight,fontFamily:this.options.font.fontFamily,textAlign:this.options.font.textAlign},this.options.gap[0],this.options.gap[1],this.options.globalAlpha,this.options.isDebug);this.appendWatermark(p,g,this.options.container)};if(this.options.image){const i=new Image;i.onload=()=>{s(i)},i.onerror=()=>{s(this.options.content)},i.crossOrigin="anonymous",i.referrerPolicy="no-referrer",i.src=this.options.image}else s(this.options.content)}}updateWatermark(t){this.options=z({...this.options},t),this.markStyle=this.getMarkStyle(),this.renderWatermark()}};q(w,"DEFAULT_WATERMARK_OPTIONS",{zIndex:9,content:["菠萝吹雪"],gap:[100,100],offset:[0,0],rotate:-22,globalAlpha:.15,isDebug:!1,font:{color:"#333",fontSize:16,fontStyle:"normal",fontWeight:"normal",fontFamily:"sans-serif",textAlign:"center"}});let H=w;return H});
